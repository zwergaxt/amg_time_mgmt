## Release Notes
### v1.1.1
- Фикс багов обновления токена. Теперь достаточно просто выйти из системы для устранения ошибки авторизации
- Рефактор Dockerfile 
- Изменен тип выпающего списка на список с поиском
- Добавлены дашборды для руководителей отделов и сметчика

### v1.1.0
- Добавлено Metabse BI

### v1.0.0
- В docker-compose.yml путь к Volume для database заменен на envvar AMG_VOL_PATH
- Добавлен раздел "Доп. соглашения"
- Добавлены отделы ОВиК, ИТР, БИМ для сотрудников
- Добавлен признак "Оплачен" в Акты
- Исправлен баг с неверной датой для отчета пользователя

## Развертывание решения

В комплекте поставки решения подготовлены несколько Dockerfile и docker-compose.yml
Предварительно для развертывания системы через Docker требуется установить необходимые пакеты:
- docker
- docker-compose  
Добавить переменную среды AMG_VOL_PATH, например:  
```
    export AMG_VOL_PATH="<путь до директории с данными БД>"
```
Затем достаточно выполнить:
```
docker compose -f docker-compose.yml up -d --build
```
Docker построит и запустит контейнеры. Сервисы системы будут доступны на тех же портах, что и при "стандартном" развертывании.

После запуска системы необходимо применить миграции
```
    docker exec -it <id контейнера с django> sh
    после подключения к контейнеру
    python manage.py migrate
```

Далее нужно создать аккаунт администратора django.
Для этого нужно выполнить:
```
    docker exec -it <id контейнера с django> sh
    после подключения к контейнеру
    python manage.py createsuperuser
```
!!! Для нового суперпользователя нужно обязательно создать Employee в админ панели <srv_name>:8000/admin!!!

#### Запуск Metabase
Для запуска Metabase нужно разместить папку bi_data из архива по любому пути в системе и задать переменную
```
    AMG_VOL_PATH_BI
```
Равную абсолютному пути к директории bi_data
Либо явно прописать пути в docker-compose.yml

В самой системе аналитики необходимо в настройках указать верного пользователя и его пароль для БД
"Шестеренка" Settings в правом верхнем углу -> Admin Settings -> Databases -> amg_db -> Edit connection details

### Пример процесса установки/обновления решения
1. Клонировать репозиторий (*) 
```
git clone <repo link>
```
2. Создать директорию data для данных системы
3. Изменить в docker-compose.yaml путь к директории с данными системы  
В сервисе database:
```
    volumes:
      - "${AMG_VOL_PATH}:/var/lib/postgresql/data"
```
    "${AMG_VOL_PATH}" - зменить на путь к директории data (или задать в ОС переменную) 
Например:
```
    volumes:
      - "/opt/amg_time/data:/var/lib/postgresql/data"
```
4. Разархивировать архив bi_data.tar
5. Изменить в docker-compose.yaml путь к директории с данными BI   
В сервисе bi_database:
```
    volumes:
      - "${AMG_VOL_PATH_BI}:/var/lib/postgresql/data"
```
    "${AMG_VOL_PATH_BI}" - заменить на путь к директории bi_data (или задать в ОС переменную)  
Например:
```
    volumes:
      - "/opt/amg_time/data:/var/lib/postgresql/bi_data"
```
6. Указать в **amg_time_front/src/index.js** перменную API_URL равную IP сервера с решением
7. Выполнить docker compose up -d --build в папке решения
8. Проверить состояние контейнеров 
```
docker ps -a
```
8a. Если есть контейнеры со статусом Exited*, то выполнить
```
docker logs <id контейнера>
```
и провести анализ ошибки

(*) - при обновлении достаточно выполнить git pull в директории решения